<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioTec</title>
    <!--<link rel="stylesheet" href="Styles/Index.css">-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">


</head>

<body style="background-color: #ffff ;">
    <header>
        <nav class="navbar navbar-expand-lg" style="background-color: #ff6a58 ;">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">BiblioTec</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#"><img src="Recursos\escudo_itt_grande.png" width="25" height="25">
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="index.html">Inicio</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="ISC.html">Subir Archivos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="ICI.html">Ver archivos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="nombres.html" style="color: red ;">INTEGRANTES DEL EQUIPO</a>
                        </li>


                    </ul>

                </div>
            </div>
        </nav>


    </header>
    <center>
        <div class="card" style="width: 50rem;">
            <form>
                <fieldset disabled>
                    <legend>Ingresa Los Datos Solicitados</legend>
        </div>
    </center>
    <br>
    <center>
        <div class="input-group mb-3" style="width: 50rem;">
            <label class="input-group-text" for="inputGroupSelect01">Carrera</label>
            <select class="form-select" id="inputGroupSelect01">
                <option selected>Carrera</option>
                <option value="1">Arquitectura</option>
                <option value="2">Ingeniería Bioquímica</option>
                <option value="3">Ingeniería Civil</option>
                <option value="4">Ingeniería Eléctrica</option>
                <option value="5">Ingeniería en Gestión Empresarial</option>
                <option value="6">Ingeniería Industrial</option>
                <option value="7">Ingeniería Mecatrónica</option>
                <option value="8">Ingeniería Química</option>
                <option value="9">Ingeniería en Sistemas Computacionales </option>
                <option value="10">Ingeniería en Tecnología de la Información y Comunicaciones</option>
                <option value="11">Licenciatura en Administración</option>
            </select>
        </div>
    </center>
    <br>
    <center>
        <div class="input-group input-group-sm mb-3" style="width: 50rem;">
            <span class="input-group-text" id="inputGroup-sizing-sm">Materia</span>
            <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" id="materia">
        </div>
    </center>
    <center>
        <div class="input-group input-group-sm mb-3" style="width: 50rem;">
            <span class="input-group-text" id="inputGroup-sizing-sm">Tema</span>
            <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" id="tema">
        </div>
    </center>

    <marquee behavior="" direction="" >Solo archivos PDF</marquee>
    <center>
        <input type="file" id="upload__pdf" class="form-control" style="background-color: #ff6a58 ;" accept="application/pdf" required>
        <!-- <button type="submit" class="btn btn-primary" style="background-color: #ff6a58 ;">Elegir Archivo</button> -->
    </center>
    <br>

    <center>
        
        <button type="button" class="btn btn-primary" style="background-color: #ff6a58 ;" id="btn_updf">Subir</button>
    </center>
    </fieldset>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-storage.js";
      const firebaseConfig = {
        apiKey: "AIzaSyDm6lM4MZAlzwzT2Rua43BErKiRyOJSMmk",
        authDomain: "bibliotec-c2ee9.firebaseapp.com",
        databaseURL: "https://bibliotec-c2ee9-default-rtdb.firebaseio.com",
        projectId: "bibliotec-c2ee9",
        storageBucket: "bibliotec-c2ee9.appspot.com",
        messagingSenderId: "988558345129",
        appId: "1:988558345129:web:79f56ff71d291fdd12bab8",
        measurementId: "G-FWNGDY46ZX"
      };

      function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}

      const app = initializeApp(firebaseConfig);
      import { getDatabase, ref as reff, set, get, child, update, remove } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
      const db = getDatabase();
      const dbRef = reff(getDatabase());
      function insertData(uuid, tipo) {
        
          set(reff(db, "Documents/"+uuid), {
            Carrera: $("#inputGroupSelect01 option:selected").text(),
            Materia: $("#materia").val(),
            Tema: $("#tema").val(),
            Archivo: uuid+tipo,
          }).then(() => {
            alert("Datos guardados correctamente")
          }).catch((err) => {
            alert("Error al guardar los datos")
          });
      }
      $("#btn_updf").on("click", async function() {
            if ( $(this).text() == "Editar") {
                update(reff(db, "Documents/"+uuid), {
                Carrera: $("#inputGroupSelect01 option:selected").text(),
                Materia: $("#materia").val(),
                Tema: $("#tema").val()
                }).then(() => {
                alert("Datos actualizados correctamente")
                      $('#upload__pdf').val('');
                      $("#btn_updf").text('Subir PDF')
                }).catch((err) => {
                alert("Error al actualizar los datos")
                });
                $(this).text('Cargando...');
                localStorage.setItem("uuid", "")
            }else{
               
            var archivo = document.getElementById('upload__pdf').files[0];
            if (!archivo) {
                return alert("Selecciona el archivo");
            }  
            $(this).text('Cargando...');
            let uuid = guid()

            let tipoArchivo = archivo.name.substr(archivo.name.lastIndexOf("."), archivo.name.legth)
     
      
            const storage = getStorage(app);
             const storageRef = ref(storage, uuid+tipoArchivo);

            uploadBytes(storageRef, archivo).then(() => {
              console.log('Uploaded a blob or file!');
                      $('#upload__pdf').val('');
                      $("#btn_updf").text('Subir PDF')
                    console.log("Archivo subido")
                insertData(uuid, tipoArchivo);
            });
            }
           
        })
        let uuid = localStorage.getItem("uuid")
        if (uuid.length > 0) {
            $("#btn_updf").text('Editar')
            get(child(dbRef, 'Documents/'+uuid)).then((snapshot) => { // OBTENER DOCUMENTOS
            if (snapshot.exists()) {
                let data = snapshot.val();
                let valor = $("option:contains('"+data.Carrera+"')").attr("value"); 
                $("#inputGroupSelect01").val(valor).change();
                $("#materia").val(data.Materia)
                $("#tema").val(data.Tema)
            }else{
                console.log("NO existe")
            }
        }).catch((error) => {
            console.log(error);
            });
        }
    </script>
</body>
<br>

<div class="container">
    <h1 class="mt-5">Gracias por colaborar!!</h1>
    <p class="lead">Recuerda solo compartir archivos estudiantiles para no afectar a la comunidad
        Tecnológica
    </p>
    <p><a href="/docs/5.2/examples/sticky-footer-navbar/">Volver al inicio</a></p>
</div>

</html>